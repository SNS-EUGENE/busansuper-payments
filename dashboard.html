<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ì‚°ìŠˆí¼ ì •ì‚° ëŒ€ì‹œë³´ë“œ</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #242424;
            --bg-hover: #2a2a2a;
            --border: #333;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0a0;
            --text-muted: #666;
            --accent-blue: #4a9eff;
            --accent-green: #4ade80;
            --accent-red: #f87171;
            --accent-purple: #a78bfa;
            --accent-yellow: #fbbf24;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 32px;
            min-height: 100vh;
            line-height: 1.6;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            font-family: inherit;
            background: var(--accent-blue);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.15s ease;
        }

        .btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        /* í†µê³„ ê·¸ë¦¬ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .stat-card .label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -1px;
            font-variant-numeric: tabular-nums;
        }

        .stat-card .unit {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-left: 4px;
        }

        .stat-card.green .value { color: var(--accent-green); }
        .stat-card.red .value { color: var(--accent-red); }
        .stat-card.blue .value { color: var(--accent-blue); }

        /* ì„¹ì…˜ ì¹´ë“œ */
        .section {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
        }

        .section-body {
            padding: 24px;
        }

        /* ìš”ì•½ ê·¸ë¦¬ë“œ */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item .label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .summary-item .value {
            font-size: 18px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .summary-item .value.green { color: var(--accent-green); }
        .summary-item .value.red { color: var(--accent-red); }

        /* ì»¨íŠ¸ë¡¤ */
        .controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        select {
            font-family: inherit;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        input[type="date"] {
            font-family: inherit;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .date-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .date-filter label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .legend {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.card { background: var(--accent-blue); }
        .legend-dot.cash { background: var(--accent-green); }

        /* í…Œì´ë¸” ê³µí†µ */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        th {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
        }

        td {
            font-size: 13px;
        }

        tbody tr:hover {
            background: var(--bg-hover);
        }

        .text-right { text-align: right; }
        .text-center { text-align: center; }

        .mono {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-size: 12px;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.3px;
        }

        .num {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-variant-numeric: tabular-nums;
        }

        /* ì•„ì½”ë””ì–¸ */
        .accordion {
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .accordion-header {
            display: grid;
            grid-template-columns: 40px 1fr 180px 32px;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .accordion-header:hover {
            background: var(--bg-hover);
        }

        .accordion-header.active {
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border);
        }

        .accordion-rank {
            width: 36px;
            height: 36px;
            background: var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .accordion-rank.top { background: var(--accent-blue); }

        .accordion-info {
            min-width: 0;
        }

        .accordion-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .accordion-meta {
            display: flex;
            gap: 24px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .accordion-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .progress-wrap {
            margin-top: 10px;
        }

        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar .fill {
            height: 100%;
            background: var(--accent-blue);
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .accordion-amount {
            text-align: right;
        }

        .accordion-amount .main {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-blue);
            font-variant-numeric: tabular-nums;
        }

        .accordion-amount .sub {
            font-size: 12px;
            color: var(--accent-red);
            margin-top: 2px;
            font-variant-numeric: tabular-nums;
        }

        .accordion-toggle {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: transform 0.2s ease;
        }

        .accordion-header.active .accordion-toggle {
            transform: rotate(180deg);
        }

        .accordion-body {
            display: none;
            background: var(--bg-primary);
        }

        .accordion-body.show {
            display: block;
        }

        .detail-table-wrap {
            max-height: 500px;
            overflow: auto;
        }

        .detail-table {
            font-size: 12px;
        }

        .detail-table th {
            font-size: 10px;
            padding: 10px 12px;
        }

        .detail-table td {
            padding: 10px 12px;
            font-size: 12px;
        }

        /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
        [title] {
            cursor: help;
        }
        .tooltip-value {
            cursor: help;
            border-bottom: 1px dotted var(--text-muted);
        }

        /* ë±ƒì§€ */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .badge-card { background: rgba(74, 158, 255, 0.15); color: var(--accent-blue); }
        .badge-cash { background: rgba(74, 222, 128, 0.15); color: var(--accent-green); }
        .badge-service { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }
        .badge-coupon { background: rgba(248, 113, 113, 0.15); color: var(--accent-red); }
        .badge-discount { background: rgba(251, 191, 36, 0.15); color: var(--accent-yellow); }
        .badge-none { background: var(--bg-tertiary); color: var(--text-muted); }

        /* ì¹´ë“œì‚¬ë³„ íƒœê·¸ */
        .badge-card-company {
            display: inline-block;
            width: 42px;
            text-align: center;
            padding: 4px 0;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-í˜„ëŒ€ì¹´ë“œ { background: #000; color: #FFF; }
        .badge-ë¡¯ë°ì¹´ë“œ { background: #e21c24; color: #FFF; }
        .badge-í•˜ë‚˜ì¹´ë“œ { background: #009178; color: #FFF; }
        .badge-ìš°ë¦¬ì¹´ë“œ { background: #0067AC; color: #FFF; }
        .badge-KBì¹´ë“œ, .badge-êµ­ë¯¼ì¹´ë“œ { background: #60584C; color: #ffb400; }
        .badge-ì‹ í•œì¹´ë“œ { background: #0046ff; color: #FFF; }
        .badge-ì‚¼ì„±ì¹´ë“œ { background: #003CDC; color: #FFF; }
        .badge-ë†í˜‘ì¹´ë“œ { background: #005CA9; color: #FFF; }
        .badge-BCì¹´ë“œ { background: #E83E44; color: #FFF; }

        /* 10ì„ í˜‘ì˜íšŒ íƒœê·¸ */
        .badge-10sun {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #FFF;
            margin-left: 6px;
            vertical-align: middle;
        }

        /* ì²´í¬ë°•ìŠ¤ í•„í„° */
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .filter-checkbox input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #764ba2;
            cursor: pointer;
        }

        /* ìœ í‹¸ë¦¬í‹° */
        .green { color: var(--accent-green); }
        .red { color: var(--accent-red); }
        .blue { color: var(--accent-blue); }
        .muted { color: var(--text-muted); }

        #loading {
            text-align: center;
            padding: 60px;
            color: var(--text-secondary);
        }

        .error-msg {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 16px 20px;
            border-radius: 8px;
            margin: 16px 0;
        }

        /* ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .modal-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .modal-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .modal-option:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
        }
        .modal-option-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .modal-option-icon.txt { background: rgba(74, 158, 255, 0.15); }
        .modal-option-icon.excel { background: rgba(74, 222, 128, 0.15); }
        .modal-option-info {
            flex: 1;
        }
        .modal-option-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        .modal-option-desc {
            font-size: 12px;
            color: var(--text-muted);
        }
        .modal-close {
            margin-top: 16px;
            text-align: center;
        }
        .modal-close button {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 13px;
            padding: 8px 16px;
        }
        .modal-close button:hover {
            color: var(--text-primary);
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .summary-grid { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 768px) {
            body { padding: 16px; }
            .stats-grid { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            .accordion-header { grid-template-columns: 36px 1fr 32px; }
            .accordion-amount { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ë¶€ì‚°ìŠˆí¼ ì •ì‚° ëŒ€ì‹œë³´ë“œ</h1>
            <div class="header-actions">
                <button class="btn" onclick="loadData()">ë¶„ì„ ì‹¤í–‰</button>
                <button class="btn btn-secondary" onclick="exportReport()">ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </header>

        <div id="loading" style="display:none;">ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>

        <div class="stats-grid" id="stats" style="display:none;">
            <div class="stat-card">
                <div class="label">ë§¤ì…ë‚´ì—­</div>
                <div class="value"><span id="stat-ë§¤ì…">-</span><span class="unit">ê±´</span></div>
            </div>
            <div class="stat-card">
                <div class="label">í¬ìŠ¤ ê²°ì œ</div>
                <div class="value"><span id="stat-í¬ìŠ¤">-</span><span class="unit">ê±´</span></div>
            </div>
            <div class="stat-card green">
                <div class="label">ë§¤ì¹­ ì„±ê³µ</div>
                <div class="value"><span id="stat-ë§¤ì¹­">-</span><span class="unit">ê±´</span></div>
            </div>
            <div class="stat-card red">
                <div class="label">ì´ ìˆ˜ìˆ˜ë£Œ</div>
                <div class="value"><span id="stat-ìˆ˜ìˆ˜ë£Œ">-</span><span class="unit">ì›</span></div>
            </div>
        </div>

        <div class="section" id="fee-analysis" style="display:none;">
            <div class="section-header">
                <div class="section-title">ì¹´ë“œì‚¬ë³„ ìˆ˜ìˆ˜ë£Œ í˜„í™©</div>
            </div>
            <div class="section-body" style="padding: 0;">
                <table id="fee-table">
                    <thead>
                        <tr>
                            <th>ì¹´ë“œì‚¬</th>
                            <th class="text-right">ê±´ìˆ˜</th>
                            <th class="text-right">ì´ ë§¤ì…ê¸ˆì•¡</th>
                            <th class="text-right">ì´ ìˆ˜ìˆ˜ë£Œ</th>
                            <th class="text-center">í‰ê·  ìˆ˜ìˆ˜ë£Œìœ¨</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="section" id="supplier-settlement" style="display:none;">
            <div class="section-header">
                <div class="section-title">ê±°ë˜ì²˜ë³„ ì •ì‚° í˜„í™©</div>
            </div>
            <div class="section-body">
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">ì´ ê±°ë˜ì²˜</div>
                        <div class="value" id="summary-suppliers">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ì´ ë§¤ì¶œ</div>
                        <div class="value" id="summary-sales">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ì´ í• ì¸</div>
                        <div class="value red" id="summary-discount">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ì¹´ë“œ ìˆ˜ìˆ˜ë£Œ</div>
                        <div class="value red" id="summary-fee">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">ì •ì‚° ì˜ˆì •</div>
                        <div class="value green" id="summary-settlement">-</div>
                    </div>
                </div>

                <div class="controls">
                    <select id="settlement-sort" onchange="sortSettlement()">
                        <option value="settlement">ì •ì‚°ì•¡ìˆœ</option>
                        <option value="sales">ë§¤ì¶œì•¡ìˆœ</option>
                        <option value="items">í’ˆëª©ìˆ˜ìˆœ</option>
                        <option value="fee">ìˆ˜ìˆ˜ë£Œìˆœ</option>
                    </select>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-dot card"></div>ì¹´ë“œê²°ì œ</div>
                        <div class="legend-item"><div class="legend-dot cash"></div>ë¹„ì¹´ë“œê²°ì œ</div>
                    </div>
                    <div class="date-filter">
                        <label class="filter-checkbox">
                            <input type="checkbox" id="filter-10sun" onchange="toggle10SunFilter()">
                            <span>10ì„ í˜‘ì˜íšŒ</span>
                        </label>
                        <span style="color:var(--border);">|</span>
                        <label>ê¸°ê°„</label>
                        <input type="date" id="date-start" onchange="filterByDate()">
                        <span style="color:var(--text-muted);">~</span>
                        <input type="date" id="date-end" onchange="filterByDate()">
                        <button class="btn btn-secondary" onclick="resetDateFilter()" style="padding:8px 12px;">ì´ˆê¸°í™”</button>
                    </div>
                </div>

                <div id="settlement-list"></div>
            </div>
        </div>

        <div class="section" id="mismatch-analysis" style="display:none;">
            <div class="section-header">
                <div class="section-title">ë§¤ì¹­ ê²€ì¦ ê²°ê³¼</div>
                <div style="font-size: 13px; color: var(--text-secondary);">
                    ìƒì‡„ <span class="green" id="offset-count">0</span>ìŒ Â·
                    í¬ìŠ¤ ë¯¸ë§¤ì¹­ <span class="red" id="pos-only-count">0</span>ê±´ Â·
                    ë§¤ì… ë¯¸ë§¤ì¹­ <span class="red" id="maip-only-count">0</span>ê±´
                </div>
            </div>
            <div class="section-body" style="padding: 0;" id="mismatch-tables"></div>
        </div>
    </div>

    <!-- ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="export-modal" onclick="closeExportModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-title">ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ</div>
            <div class="modal-desc">í˜„ì¬ í•„í„°ê°€ ì ìš©ëœ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</div>
            <div class="modal-checkbox" style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" id="fee-uniform-check" style="width: 18px; height: 18px; cursor: pointer;">
                    <span>ìˆ˜ìˆ˜ë£Œ 3.5% ì¼ê´„ ì ìš© (ì¹´ë“œ/í˜„ê¸ˆ êµ¬ë¶„ ì—†ì´)</span>
                </label>
                <div style="font-size: 11px; color: var(--text-muted); margin-top: 6px; margin-left: 28px;">
                    ì²´í¬ ì‹œ ëª¨ë“  í’ˆëª©ì— 3.5% ìˆ˜ìˆ˜ë£Œë¥¼ ì ìš©í•˜ì—¬ ê³„ì‚°í•©ë‹ˆë‹¤
                </div>
            </div>
            <div class="modal-options">
                <div class="modal-option" onclick="exportText()">
                    <div class="modal-option-icon txt">ğŸ“„</div>
                    <div class="modal-option-info">
                        <div class="modal-option-title">í…ìŠ¤íŠ¸ íŒŒì¼ (.txt)</div>
                        <div class="modal-option-desc">ê°„ë‹¨í•œ ìš”ì•½ ë¦¬í¬íŠ¸</div>
                    </div>
                </div>
                <div class="modal-option" onclick="exportExcel()">
                    <div class="modal-option-icon excel">ğŸ“Š</div>
                    <div class="modal-option-info">
                        <div class="modal-option-title">ì—‘ì…€ íŒŒì¼ (.xlsx)</div>
                        <div class="modal-option-desc">ì—…ì²´ë³„ ìƒì„¸ ë‚´ì—­ (ì‹œíŠ¸ ë¶„ë¦¬)</div>
                    </div>
                </div>
                <div class="modal-option" onclick="exportExcelSettlement()">
                    <div class="modal-option-icon excel" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">ğŸ“‹</div>
                    <div class="modal-option-info">
                        <div class="modal-option-title">ì •ì‚°ìš© ì—‘ì…€ (.xlsx)</div>
                        <div class="modal-option-desc">3.5% ìˆ˜ìˆ˜ë£Œ ì¼ê´„ ì ìš©, ê°„ê²°í•œ í˜•ì‹</div>
                    </div>
                </div>
            </div>
            <div class="modal-close">
                <button onclick="closeExportModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script>
        let analysisData = null;
        let settlementData = [];
        let originalSettlementData = [];
        let dateStart = '';
        let dateEnd = '';
        let filter10Sun = false;

        // ë¶€ì‚°ê´€ê´‘ê¸°ë…í’ˆ10ì„ í˜‘ì˜íšŒ ì†Œì† ì—…ì²´ ëª©ë¡
        const í˜‘ì˜íšŒì—…ì²´ëª©ë¡ = new Set([
            'í•œêµ­ë°”ì´ì˜¤ë·°í‹°', 'ë„ë ˆë§', 'ë…¸ì‰¬í”„ë¡œì íŠ¸', 'í…Œì´ìŠ¤í‹°í‚¤ì¹œ', 'ë§Œë“¤ê¿ˆ',
            'ë¶€ì‚°ê³ ë“±ì–´ë¹µ', 'ë³´ì•„ìŠ¤', 'ë””ìì¸í”ŒëŸ¬ìŠ¤ë§ˆì¸ë“œ', 'ì˜¨ë„ë‹´', 'ì´ì†”ê³µë°©',
            'ê³ ë¯¸ë‘', 'ìŠ¤í† ë¦¬ì§„', 'ë¶€ì‚°ì£¼ë‹¹', 'ì¹´í˜385', 'í•¸ë“œë©”ì´ë“œì¸',
            'ë„“ì€ë¿Œë¦¬ê³µì‘ì†Œ', 'ì†”íŠ¸ì»´ë°”ì¸', 'ì”¨ë“œ', 'ì¿ ë„', 'ì½˜í…ì¸ ì½”ì–´',
            'ë””ìì¸ë¶€ì‚°', 'ëª¨ì´ë‹¤', 'ë¯¸ë‹ˆë°”ë‹¤', 'ì°©í•œì„¸ìƒ', 'ëª¨ë‹¤ë¼',
            'ëŒ€í•œê³µì˜ˆ', 'ì½”ìŠ¤ë§ˆì¼'
        ]);
        const í˜‘ì˜íšŒìºì‹œ = new Map();

        function is10SunMember(ê±°ë˜ì²˜ëª…) {
            if (í˜‘ì˜íšŒìºì‹œ.has(ê±°ë˜ì²˜ëª…)) return í˜‘ì˜íšŒìºì‹œ.get(ê±°ë˜ì²˜ëª…);
            const result = í˜‘ì˜íšŒì—…ì²´ëª©ë¡.has(ê±°ë˜ì²˜ëª…) ||
                [...í˜‘ì˜íšŒì—…ì²´ëª©ë¡].some(name => ê±°ë˜ì²˜ëª….includes(name) || name.includes(ê±°ë˜ì²˜ëª…));
            í˜‘ì˜íšŒìºì‹œ.set(ê±°ë˜ì²˜ëª…, result);
            return result;
        }

        function formatNumber(n) {
            return (n || 0).toLocaleString();
        }

        function formatMoney(n) {
            if (n >= 10000) return (n / 10000).toFixed(1) + 'ë§Œ';
            return formatNumber(n);
        }

        function formatMoneyWithTooltip(n, suffix = 'ì›') {
            const exact = formatNumber(n) + suffix;
            if (n >= 10000) {
                const short = (n / 10000).toFixed(1) + 'ë§Œ' + suffix;
                return `<span class="tooltip-value" title="${exact}">${short}</span>`;
            }
            return `<span>${exact}</span>`;
        }

        function excelDateToString(serial) {
            if (!serial || isNaN(serial)) return '-';
            const date = new Date((serial - 25569) * 86400000);
            return date.toISOString().split('T')[0];
        }

        async function loadData() {
            document.getElementById('loading').style.display = 'block';

            try {
                const response = await fetch('/api/analyze');
                if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + response.status);
                analysisData = await response.json();
                renderDashboard();
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-msg';
                errorDiv.textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message;
                document.querySelector('.container').appendChild(errorDiv);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderDashboard() {
            if (!analysisData) return;

            document.getElementById('stats').style.display = 'grid';
            document.getElementById('stat-ë§¤ì…').textContent = formatNumber(analysisData.ìš”ì•½.ë§¤ì…ë‚´ì—­ê±´ìˆ˜);
            document.getElementById('stat-í¬ìŠ¤').textContent = formatNumber(analysisData.ìš”ì•½.í¬ìŠ¤ê²°ì œê±´ìˆ˜);
            document.getElementById('stat-ë§¤ì¹­').textContent = formatNumber(analysisData.ë§¤ì¹­ê²°ê³¼?.ë§¤ì¹­ëœí•­ëª© || 0);

            let ì´ìˆ˜ìˆ˜ë£Œ = 0;
            if (analysisData.ìˆ˜ìˆ˜ë£Œí†µê³„) {
                Object.values(analysisData.ìˆ˜ìˆ˜ë£Œí†µê³„).forEach(s => ì´ìˆ˜ìˆ˜ë£Œ += s.ì´ìˆ˜ìˆ˜ë£Œ || 0);
            }
            document.getElementById('stat-ìˆ˜ìˆ˜ë£Œ').textContent = formatNumber(ì´ìˆ˜ìˆ˜ë£Œ);

            if (analysisData.ìˆ˜ìˆ˜ë£Œí†µê³„) renderFeeTable();
            if (analysisData.ê±°ë˜ì²˜ì •ì‚°) renderSettlement();
            renderMismatch();
        }

        function renderFeeTable() {
            document.getElementById('fee-analysis').style.display = 'block';
            const tbody = document.getElementById('fee-table').querySelector('tbody');
            tbody.innerHTML = '';

            Object.entries(analysisData.ìˆ˜ìˆ˜ë£Œí†µê³„)
                .sort((a, b) => b[1].ì´ìˆ˜ìˆ˜ë£Œ - a[1].ì´ìˆ˜ìˆ˜ë£Œ)
                .forEach(([ì¹´ë“œì‚¬, s]) => {
                    const ìˆ˜ìˆ˜ë£Œìœ¨ = (s.ì´ìˆ˜ìˆ˜ë£Œ / s.ì´ë§¤ì…ê¸ˆì•¡ * 100).toFixed(2);
                    const ì¹´ë“œì‚¬ë±ƒì§€ = getCardCompanyBadge(ì¹´ë“œì‚¬);
                    tbody.innerHTML += `
                        <tr>
                            <td>${ì¹´ë“œì‚¬ë±ƒì§€}</td>
                            <td class="text-right mono">${formatNumber(s.ê±´ìˆ˜)}</td>
                            <td class="text-right mono">${formatNumber(s.ì´ë§¤ì…ê¸ˆì•¡)}</td>
                            <td class="text-right mono red">${formatNumber(s.ì´ìˆ˜ìˆ˜ë£Œ)}</td>
                            <td class="text-center"><span class="blue" style="font-weight:600;">${ìˆ˜ìˆ˜ë£Œìœ¨}%</span></td>
                        </tr>
                    `;
                });
        }

        function renderSettlement() {
            document.getElementById('supplier-settlement').style.display = 'block';
            originalSettlementData = Object.values(analysisData.ê±°ë˜ì²˜ì •ì‚°);

            // 10ì„ í˜‘ì˜íšŒ ì—¬ë¶€ ë¯¸ë¦¬ ìºì‹œ
            originalSettlementData.forEach(s => {
                s._is10Sun = is10SunMember(s.ê±°ë˜ì²˜);
            });

            settlementData = originalSettlementData;

            // ë‚ ì§œ ë²”ìœ„ ìë™ ì„¤ì •
            let minDate = null, maxDate = null;
            originalSettlementData.forEach(s => {
                (s.í’ˆëª©ë³„ìƒì„¸ || []).forEach(item => {
                    if (item.ê²°ì œì¼ì) {
                        if (!minDate || item.ê²°ì œì¼ì < minDate) minDate = item.ê²°ì œì¼ì;
                        if (!maxDate || item.ê²°ì œì¼ì > maxDate) maxDate = item.ê²°ì œì¼ì;
                    }
                });
            });
            if (minDate) document.getElementById('date-start').value = minDate;
            if (maxDate) document.getElementById('date-end').value = maxDate;

            updateSettlementSummary();
            sortSettlement();
        }

        function updateSettlementSummary() {
            let ì´ë§¤ì¶œ = 0, ì´í• ì¸ = 0, ì´ìˆ˜ìˆ˜ë£Œ = 0, ì´ì •ì‚° = 0;
            settlementData.forEach(s => {
                ì´ë§¤ì¶œ += s.ì´ë§¤ì¶œ || 0;
                ì´í• ì¸ += s.ì´í• ì¸ || 0;
                ì´ìˆ˜ìˆ˜ë£Œ += s.ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ || 0;
                ì´ì •ì‚° += s.ì •ì‚°ì˜ˆì •ì•¡ || 0;
            });

            document.getElementById('summary-suppliers').textContent = settlementData.length + 'ê°œ';
            document.getElementById('summary-sales').innerHTML = formatMoneyWithTooltip(ì´ë§¤ì¶œ);
            document.getElementById('summary-discount').innerHTML = '-' + formatMoneyWithTooltip(ì´í• ì¸);
            document.getElementById('summary-fee').innerHTML = '-' + formatMoneyWithTooltip(ì´ìˆ˜ìˆ˜ë£Œ);
            document.getElementById('summary-settlement').innerHTML = formatMoneyWithTooltip(ì´ì •ì‚°);
        }

        function filterByDate() {
            dateStart = document.getElementById('date-start').value;
            dateEnd = document.getElementById('date-end').value;
            applyFilters();
        }

        function resetDateFilter() {
            document.getElementById('date-start').value = '';
            document.getElementById('date-end').value = '';
            dateStart = '';
            dateEnd = '';
            applyFilters();
        }

        function toggle10SunFilter() {
            filter10Sun = document.getElementById('filter-10sun').checked;
            applyFilters();
        }

        function applyFilters() {
            // ì›ë³¸ ë°ì´í„°ì—ì„œ ì‹œì‘
            let filtered = originalSettlementData;

            // 10ì„ í˜‘ì˜íšŒ í•„í„° ì ìš© (ìºì‹œëœ ê°’ ì‚¬ìš©)
            if (filter10Sun) {
                filtered = filtered.filter(s => s._is10Sun);
            }

            // ë‚ ì§œ í•„í„° ì ìš©
            if (dateStart || dateEnd) {
                filtered = filtered.map(s => {
                    const filteredItems = (s.í’ˆëª©ë³„ìƒì„¸ || []).filter(item => {
                        const d = item.ê²°ì œì¼ì;
                        if (!d) return false;
                        if (dateStart && d < dateStart) return false;
                        if (dateEnd && d > dateEnd) return false;
                        return true;
                    });

                    if (filteredItems.length === 0) return null;

                    // í•„í„°ëœ í’ˆëª©ìœ¼ë¡œ í†µê³„ ì¬ê³„ì‚°
                    let ì´ë§¤ì¶œ = 0, ì´í• ì¸ = 0, ì‹¤ë§¤ì¶œ = 0, ì¹´ë“œë§¤ì¶œ = 0, ë¹„ì¹´ë“œë§¤ì¶œ = 0;
                    let ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ = 0, ì •ì‚°ì˜ˆì •ì•¡ = 0, ì¹´ë“œí’ˆëª©ìˆ˜ = 0, ë¹„ì¹´ë“œí’ˆëª©ìˆ˜ = 0;

                    filteredItems.forEach(item => {
                        ì´ë§¤ì¶œ += item.ì´ë§¤ì¶œì•¡ || 0;
                        ì´í• ì¸ += item.í• ì¸ì•¡ || 0;
                        ì‹¤ë§¤ì¶œ += (item.ì´ë§¤ì¶œì•¡ || 0) - (item.í• ì¸ì•¡ || 0);
                        ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ += item.ì¹´ë“œìˆ˜ìˆ˜ë£Œ || 0;
                        ì •ì‚°ì˜ˆì •ì•¡ += item.ì •ì‚°ì•¡ || 0;

                        if (item.ì¹´ë“œì—¬ë¶€) {
                            ì¹´ë“œë§¤ì¶œ += (item.ì´ë§¤ì¶œì•¡ || 0) - (item.í• ì¸ì•¡ || 0);
                            ì¹´ë“œí’ˆëª©ìˆ˜++;
                        } else {
                            ë¹„ì¹´ë“œë§¤ì¶œ += (item.ì´ë§¤ì¶œì•¡ || 0) - (item.í• ì¸ì•¡ || 0);
                            ë¹„ì¹´ë“œí’ˆëª©ìˆ˜++;
                        }
                    });

                    return {
                        ...s,
                        ì´ë§¤ì¶œ,
                        ì´í• ì¸,
                        ì‹¤ë§¤ì¶œ,
                        ì¹´ë“œë§¤ì¶œ,
                        ë¹„ì¹´ë“œë§¤ì¶œ,
                        ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„,
                        ì •ì‚°ì˜ˆì •ì•¡,
                        í’ˆëª©ìˆ˜: filteredItems.length,
                        ì¹´ë“œí’ˆëª©ìˆ˜,
                        ë¹„ì¹´ë“œí’ˆëª©ìˆ˜,
                        í’ˆëª©ë³„ìƒì„¸: filteredItems
                    };
                }).filter(s => s !== null);
            }

            settlementData = filtered;
            updateSettlementSummary();
            sortSettlement();
        }

        function sortSettlement() {
            const sort = document.getElementById('settlement-sort').value;
            const sorted = [...settlementData].sort((a, b) => {
                switch (sort) {
                    case 'sales': return (b.ì´ë§¤ì¶œ || 0) - (a.ì´ë§¤ì¶œ || 0);
                    case 'items': return (b.í’ˆëª©ìˆ˜ || 0) - (a.í’ˆëª©ìˆ˜ || 0);
                    case 'fee': return (b.ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ || 0) - (a.ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ || 0);
                    default: return (b.ì •ì‚°ì˜ˆì •ì•¡ || 0) - (a.ì •ì‚°ì˜ˆì •ì•¡ || 0);
                }
            });
            renderSettlementList(sorted);
        }

        // í˜„ì¬ ë Œë”ëœ ë°ì´í„° ì €ì¥ (ì§€ì—° ë¡œë”©ìš©)
        let currentListData = [];

        function renderSettlementList(data) {
            currentListData = data;
            const container = document.getElementById('settlement-list');

            // ë°°ì—´ë¡œ ëª¨ì•„ì„œ í•œë²ˆì— ë Œë”ë§ (ì„±ëŠ¥ ìµœì í™”)
            const html = data.map((s, idx) => {
                const ì¹´ë“œë¹„ìœ¨ = s.ì‹¤ë§¤ì¶œ > 0 ? (s.ì¹´ë“œë§¤ì¶œ / s.ì‹¤ë§¤ì¶œ * 100) : 0;
                const id = 'acc-' + idx;
                const tag10Sun = s._is10Sun ? '<span class="badge-10sun">10ì„ í˜‘ì˜íšŒ</span>' : '';

                return `
                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion('${id}', ${idx})">
                            <div class="accordion-rank ${idx < 3 ? 'top' : ''}">${idx + 1}</div>
                            <div class="accordion-info">
                                <div class="accordion-title">${s.ê±°ë˜ì²˜}${tag10Sun}</div>
                                <div class="accordion-meta">
                                    <span>í’ˆëª© <strong>${s.í’ˆëª©ìˆ˜}</strong>ê±´</span>
                                    <span>ì¹´ë“œ <strong>${s.ì¹´ë“œí’ˆëª©ìˆ˜}</strong></span>
                                    <span>ë¹„ì¹´ë“œ <strong>${s.ë¹„ì¹´ë“œí’ˆëª©ìˆ˜}</strong></span>
                                    <span>ë§¤ì¶œ <strong title="${formatNumber(s.ì´ë§¤ì¶œ)}ì›">${formatMoney(s.ì´ë§¤ì¶œ)}</strong>ì›</span>
                                </div>
                                <div class="progress-wrap">
                                    <div class="progress-bar"><div class="fill" style="width:${ì¹´ë“œë¹„ìœ¨.toFixed(1)}%"></div></div>
                                    <div class="progress-label">
                                        <span title="${formatNumber(s.ì¹´ë“œë§¤ì¶œ)}ì›">ì¹´ë“œ ${formatMoney(s.ì¹´ë“œë§¤ì¶œ)}ì› (${ì¹´ë“œë¹„ìœ¨.toFixed(1)}%)</span>
                                        <span title="${formatNumber(s.ë¹„ì¹´ë“œë§¤ì¶œ)}ì›">ë¹„ì¹´ë“œ ${formatMoney(s.ë¹„ì¹´ë“œë§¤ì¶œ)}ì›</span>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-amount">
                                <div class="main" title="${formatNumber(s.ì •ì‚°ì˜ˆì •ì•¡)}ì›">${formatMoney(s.ì •ì‚°ì˜ˆì •ì•¡)}ì›</div>
                                <div class="sub" title="${formatNumber(s.ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„)}ì›">ìˆ˜ìˆ˜ë£Œ -${formatMoney(s.ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„)}ì›</div>
                            </div>
                            <div class="accordion-toggle">â–¼</div>
                        </div>
                        <div class="accordion-body" id="${id}" data-idx="${idx}"></div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function renderDetailTable(items) {
            if (!items.length) return '<div style="padding:24px;text-align:center;color:var(--text-muted);">ìƒì„¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';

            // ì»¬ëŸ¼ ìˆœì„œ: ê²°ì œì¼ì-ì •ì‚°ì¼ì-ì¹´ë“œ/í˜„ê¸ˆ-ì¹´ë“œì‚¬-ì¹´ë“œìˆ˜ìˆ˜ë£Œìœ¨-ìƒí’ˆëª…-ìƒí’ˆì½”ë“œ-ìƒí’ˆë°”ì½”ë“œ-ê°€ê²©-íŒë§¤ê°€-í• ì¸ì—¬ë¶€-í• ì¸ìœ¨-í• ì¸ì•¡-ì¹´ë“œìˆ˜ìˆ˜ë£Œ-ìµœì¢…ì •ì‚°ì•¡
            let rows = items.map(item => {
                const ê²°ì œë±ƒì§€ = item.ì¹´ë“œì—¬ë¶€
                    ? '<span class="badge badge-card">ì¹´ë“œ</span>'
                    : '<span class="badge badge-cash">í˜„ê¸ˆ</span>';
                const í• ì¸ë±ƒì§€ = item.í• ì¸ì—¬ë¶€
                    ? '<span class="badge badge-discount">Y</span>'
                    : '<span class="badge badge-none">N</span>';

                const ì¹´ë“œì‚¬ë±ƒì§€ = getCardCompanyBadge(item.ì¹´ë“œì‚¬);

                return `
                    <tr>
                        <td class="mono">${item.ê²°ì œì¼ì || '-'}</td>
                        <td class="mono">${item.ì •ì‚°ì¼ì || '-'}</td>
                        <td class="text-center">${ê²°ì œë±ƒì§€}</td>
                        <td>${ì¹´ë“œì‚¬ë±ƒì§€}</td>
                        <td class="text-center mono ${item.ì¹´ë“œìˆ˜ìˆ˜ë£Œìœ¨ > 0 ? 'blue' : 'muted'}">${item.ì¹´ë“œìˆ˜ìˆ˜ë£Œìœ¨ > 0 ? item.ì¹´ë“œìˆ˜ìˆ˜ë£Œìœ¨ + '%' : '-'}</td>
                        <td>${item.ìƒí’ˆëª… || '-'}</td>
                        <td class="mono muted">${item.ìƒí’ˆì½”ë“œ || '-'}</td>
                        <td class="mono muted">${item.ìƒí’ˆë°”ì½”ë“œ || '-'}</td>
                        <td class="text-right mono">${formatNumber(item.íŒë§¤ë‹¨ê°€)}</td>
                        <td class="text-right mono">${formatNumber(item.ì´ë§¤ì¶œì•¡)}</td>
                        <td class="text-center">${í• ì¸ë±ƒì§€}</td>
                        <td class="text-center mono ${item.í• ì¸ìœ¨ > 0 ? 'red' : 'muted'}">${item.í• ì¸ìœ¨ > 0 ? item.í• ì¸ìœ¨ + '%' : '-'}</td>
                        <td class="text-right mono ${item.í• ì¸ì•¡ > 0 ? 'red' : 'muted'}">${item.í• ì¸ì•¡ > 0 ? '-' + formatNumber(item.í• ì¸ì•¡) : '-'}</td>
                        <td class="text-right mono ${item.ì¹´ë“œìˆ˜ìˆ˜ë£Œ > 0 ? 'red' : 'muted'}">${item.ì¹´ë“œìˆ˜ìˆ˜ë£Œ > 0 ? '-' + formatNumber(item.ì¹´ë“œìˆ˜ìˆ˜ë£Œ) : '-'}</td>
                        <td class="text-right mono"><strong class="green">${formatNumber(item.ì •ì‚°ì•¡)}</strong></td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="detail-table-wrap">
                    <table class="detail-table">
                        <thead>
                            <tr>
                                <th>ê²°ì œì¼ì</th>
                                <th>ì •ì‚°ì¼ì</th>
                                <th class="text-center">ì¹´ë“œ/í˜„ê¸ˆ</th>
                                <th>ì¹´ë“œì‚¬</th>
                                <th class="text-center">ìˆ˜ìˆ˜ë£Œìœ¨</th>
                                <th>ìƒí’ˆëª…</th>
                                <th>ìƒí’ˆì½”ë“œ</th>
                                <th>ë°”ì½”ë“œ</th>
                                <th class="text-right">ê°€ê²©</th>
                                <th class="text-right">íŒë§¤ê°€</th>
                                <th class="text-center">í• ì¸</th>
                                <th class="text-center">í• ì¸ìœ¨</th>
                                <th class="text-right">í• ì¸ì•¡</th>
                                <th class="text-right">ìˆ˜ìˆ˜ë£Œ</th>
                                <th class="text-right">ì •ì‚°ì•¡</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        function getDiscountBadge(type) {
            if (!type) return '<span class="badge badge-none">ì¼ë°˜</span>';
            if (type.includes('ì„œë¹„ìŠ¤')) return '<span class="badge badge-service">ì„œë¹„ìŠ¤</span>';
            if (type.includes('ì¿ í°')) return '<span class="badge badge-coupon">ì¿ í°</span>';
            if (type.includes('50%')) return '<span class="badge badge-discount">50%</span>';
            if (type.includes('20%')) return '<span class="badge badge-discount">20%</span>';
            if (type.includes('í• ì¸')) return '<span class="badge badge-discount">í• ì¸</span>';
            return '<span class="badge badge-none">ì¼ë°˜</span>';
        }

        function getCardCompanyBadge(cardName) {
            if (!cardName || cardName === '-') return '<span class="muted">-</span>';

            // ì¹´ë“œì‚¬ëª… ì •ê·œí™”
            let badgeClass = 'badge-none';
            let displayName = cardName;

            if (cardName.includes('í˜„ëŒ€')) { badgeClass = 'badge-í˜„ëŒ€ì¹´ë“œ'; displayName = 'í˜„ëŒ€'; }
            else if (cardName.includes('ë¡¯ë°')) { badgeClass = 'badge-ë¡¯ë°ì¹´ë“œ'; displayName = 'ë¡¯ë°'; }
            else if (cardName.includes('í•˜ë‚˜')) { badgeClass = 'badge-í•˜ë‚˜ì¹´ë“œ'; displayName = 'í•˜ë‚˜'; }
            else if (cardName.includes('ìš°ë¦¬')) { badgeClass = 'badge-ìš°ë¦¬ì¹´ë“œ'; displayName = 'ìš°ë¦¬'; }
            else if (cardName.includes('KB') || cardName.includes('êµ­ë¯¼')) { badgeClass = 'badge-KBì¹´ë“œ'; displayName = 'KB'; }
            else if (cardName.includes('ì‹ í•œ')) { badgeClass = 'badge-ì‹ í•œì¹´ë“œ'; displayName = 'ì‹ í•œ'; }
            else if (cardName.includes('ì‚¼ì„±')) { badgeClass = 'badge-ì‚¼ì„±ì¹´ë“œ'; displayName = 'ì‚¼ì„±'; }
            else if (cardName.includes('ë†í˜‘')) { badgeClass = 'badge-ë†í˜‘ì¹´ë“œ'; displayName = 'ë†í˜‘'; }
            else if (cardName.includes('BC') || cardName.includes('ë¹„ì”¨')) { badgeClass = 'badge-BCì¹´ë“œ'; displayName = 'BC'; }

            return `<span class="badge badge-card-company ${badgeClass}">${displayName}</span>`;
        }

        function toggleAccordion(id, idx) {
            const body = document.getElementById(id);
            const header = body.previousElementSibling;

            // ì§€ì—° ë¡œë”©: ì²˜ìŒ ì—´ ë•Œë§Œ ìƒì„¸ í…Œì´ë¸” ë Œë”ë§
            if (!body.innerHTML && currentListData[idx]) {
                body.innerHTML = renderDetailTable(currentListData[idx].í’ˆëª©ë³„ìƒì„¸ || []);
            }

            body.classList.toggle('show');
            header.classList.toggle('active');
        }

        function renderMismatch() {
            document.getElementById('mismatch-analysis').style.display = 'block';

            const offset = analysisData.ë§¤ì¹­ê²°ê³¼?.ìƒì‡„ëœê±°ë˜ || [];
            const posOnly = analysisData.ë§¤ì¹­ê²°ê³¼?.í¬ìŠ¤ëˆ„ë½ || [];
            const maipOnly = analysisData.ë§¤ì¹­ê²°ê³¼?.ë§¤ì…ëˆ„ë½ || [];

            document.getElementById('offset-count').textContent = offset.length;
            document.getElementById('pos-only-count').textContent = posOnly.length;
            document.getElementById('maip-only-count').textContent = maipOnly.length;

            let html = '';

            if (posOnly.length > 0) {
                html += `
                    <table>
                        <thead><tr><th colspan="4" style="color:var(--accent-red);">í¬ìŠ¤ì—ë§Œ ìˆëŠ” ë‚´ì—­ (${posOnly.length}ê±´)</th></tr>
                        <tr><th>ì¼ì</th><th>ì¹´ë“œì‚¬</th><th class="text-right">ê¸ˆì•¡</th><th>ì‚¬ìœ </th></tr></thead>
                        <tbody>
                `;
                posOnly.slice(0, 20).forEach(item => {
                    const d = item.í¬ìŠ¤ë°ì´í„° || {};
                    html += `<tr>
                        <td class="mono">${d.ì˜ì—…ì¼ì ? excelDateToString(d.ì˜ì—…ì¼ì) : '-'}</td>
                        <td>${d.ë§¤ì…ì‚¬ || '-'}</td>
                        <td class="text-right mono">${formatNumber(d.ìŠ¹ì¸ê¸ˆì•¡)}</td>
                        <td class="muted">${item.ì´ìœ  || '-'}</td>
                    </tr>`;
                });
                if (posOnly.length > 20) html += `<tr><td colspan="4" class="muted text-center">ì™¸ ${posOnly.length - 20}ê±´</td></tr>`;
                html += '</tbody></table>';
            }

            if (maipOnly.length > 0) {
                html += `
                    <table style="margin-top:16px;">
                        <thead><tr><th colspan="4" style="color:var(--accent-red);">ë§¤ì…ì—ë§Œ ìˆëŠ” ë‚´ì—­ (${maipOnly.length}ê±´)</th></tr>
                        <tr><th>ì¼ì</th><th>ì¹´ë“œì‚¬</th><th class="text-right">ê¸ˆì•¡</th><th class="text-right">ìˆ˜ìˆ˜ë£Œ</th></tr></thead>
                        <tbody>
                `;
                maipOnly.forEach(item => {
                    const d = item.ë§¤ì…ë°ì´í„° || {};
                    html += `<tr>
                        <td class="mono">${d.ê±°ë˜ì¼ì || '-'}</td>
                        <td>${d.ì¹´ë“œì‚¬ || '-'}</td>
                        <td class="text-right mono">${formatNumber(d.ë§¤ì…ê¸ˆì•¡)}</td>
                        <td class="text-right mono red">${formatNumber(d['ìˆ˜ìˆ˜ë£Œí•©ê³„(B)'])}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }

            document.getElementById('mismatch-tables').innerHTML = html || '<div style="padding:24px;text-align:center;color:var(--text-muted);">ë¯¸ë§¤ì¹­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        function exportReport() {
            if (!analysisData) return alert('ë¨¼ì € ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.');
            document.getElementById('export-modal').classList.add('show');
        }

        function closeExportModal(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('export-modal').classList.remove('show');
            }
        }

        function getFilterDescription() {
            let desc = [];
            if (filter10Sun) desc.push('10ì„ í˜‘ì˜íšŒ');
            if (dateStart || dateEnd) {
                const start = dateStart || 'ì‹œì‘';
                const end = dateEnd || 'ì¢…ë£Œ';
                desc.push(`ê¸°ê°„: ${start} ~ ${end}`);
            }
            const sortOption = document.getElementById('settlement-sort').value;
            const sortNames = { settlement: 'ì •ì‚°ì•¡ìˆœ', sales: 'ë§¤ì¶œì•¡ìˆœ', items: 'í’ˆëª©ìˆ˜ìˆœ', fee: 'ìˆ˜ìˆ˜ë£Œìˆœ' };
            desc.push(`ì •ë ¬: ${sortNames[sortOption] || sortOption}`);
            return desc.length > 0 ? desc.join(' / ') : 'ì „ì²´';
        }

        function exportText() {
            closeExportModal();

            const filterDesc = getFilterDescription();
            const periodDesc = (dateStart || dateEnd) ? `${dateStart || 'ì‹œì‘'} ~ ${dateEnd || 'ì¢…ë£Œ'}` : 'ì „ì²´ ê¸°ê°„';

            let report = `ë¶€ì‚°ìŠˆí¼ ì •ì‚° ëŒ€ì‹œë³´ë“œ\n`;
            report += `ìƒì„±: ${new Date().toLocaleString()}\n`;
            report += `í•„í„°: ${filterDesc}\n`;
            report += `${'='.repeat(50)}\n\n`;

            // ìš”ì•½
            let ì´ë§¤ì¶œ = 0, ì´í• ì¸ = 0, ì´ìˆ˜ìˆ˜ë£Œ = 0, ì´ì •ì‚° = 0;
            settlementData.forEach(s => {
                ì´ë§¤ì¶œ += s.ì´ë§¤ì¶œ || 0;
                ì´í• ì¸ += s.ì´í• ì¸ || 0;
                ì´ìˆ˜ìˆ˜ë£Œ += s.ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ || 0;
                ì´ì •ì‚° += s.ì •ì‚°ì˜ˆì •ì•¡ || 0;
            });

            report += `[ìš”ì•½]\n`;
            report += `ê±°ë˜ì²˜: ${settlementData.length}ê°œ\n`;
            report += `ì´ ë§¤ì¶œ: ${formatNumber(ì´ë§¤ì¶œ)}ì›\n`;
            report += `ì´ í• ì¸: ${formatNumber(ì´í• ì¸)}ì›\n`;
            report += `ì¹´ë“œ ìˆ˜ìˆ˜ë£Œ: ${formatNumber(ì´ìˆ˜ìˆ˜ë£Œ)}ì›\n`;
            report += `ì •ì‚° ì˜ˆì •: ${formatNumber(ì´ì •ì‚°)}ì›\n\n`;

            report += `[ê±°ë˜ì²˜ë³„ ì •ì‚°]\n`;
            report += `${'â”€'.repeat(50)}\n`;
            settlementData.forEach((s, i) => {
                const tag10Sun = s._is10Sun ? ' [10ì„ í˜‘ì˜íšŒ]' : '';
                report += `${i + 1}. ${s.ê±°ë˜ì²˜}${tag10Sun}\n`;
                report += `   ë§¤ì¶œ: ${formatNumber(s.ì´ë§¤ì¶œ)}ì› / í• ì¸: ${formatNumber(s.ì´í• ì¸)}ì›\n`;
                report += `   ì¹´ë“œ: ${formatNumber(s.ì¹´ë“œë§¤ì¶œ)}ì› / ë¹„ì¹´ë“œ: ${formatNumber(s.ë¹„ì¹´ë“œë§¤ì¶œ)}ì›\n`;
                report += `   ìˆ˜ìˆ˜ë£Œ: ${formatNumber(s.ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„)}ì› â†’ ì •ì‚°: ${formatNumber(s.ì •ì‚°ì˜ˆì •ì•¡)}ì›\n`;
                report += `   í’ˆëª©: ${s.í’ˆëª©ìˆ˜}ê±´ (ì¹´ë“œ ${s.ì¹´ë“œí’ˆëª©ìˆ˜} / ë¹„ì¹´ë“œ ${s.ë¹„ì¹´ë“œí’ˆëª©ìˆ˜})\n`;
                report += `${'â”€'.repeat(50)}\n`;
            });

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const dateStr = new Date().toISOString().split('T')[0];
            a.download = `ì •ì‚°ë¦¬í¬íŠ¸_${dateStr}.txt`;
            a.click();
        }

        function exportExcel() {
            // 3.5% ìˆ˜ìˆ˜ë£Œ ì¼ê´„ ì ìš© ì—¬ë¶€ í™•ì¸
            const uniformFee = document.getElementById('fee-uniform-check').checked;

            closeExportModal();

            if (typeof XLSX === 'undefined') {
                alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë°ì´í„° ë³µì‚¬ (ì›ë³¸ ë³´ì¡´)
            let exportData = settlementData;
            if (uniformFee) {
                exportData = JSON.parse(JSON.stringify(settlementData)); // ê¹Šì€ ë³µì‚¬
                const uniformRate = 0.035; // 3.5%

                exportData.forEach(s => {
                    let ìƒˆì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ = 0;
                    let ìƒˆì •ì‚°ì˜ˆì •ì•¡ = 0;

                    if (s.í’ˆëª©ë³„ìƒì„¸) {
                        s.í’ˆëª©ë³„ìƒì„¸.forEach(item => {
                            // ëª¨ë“  í’ˆëª©ì— 3.5% ìˆ˜ìˆ˜ë£Œ ì ìš© (ì¹´ë“œ/í˜„ê¸ˆ êµ¬ë¶„ ì—†ì´)
                            const ì •ì‚°ê¸°ì¤€ì•¡ = item.ì •ì‚°ì•¡ + (item.ì¹´ë“œìˆ˜ìˆ˜ë£Œ || 0); // ì›ë˜ ì •ì‚°ê¸°ì¤€ì•¡ ë³µì›
                            const ìƒˆìˆ˜ìˆ˜ë£Œ = Math.trunc(ì •ì‚°ê¸°ì¤€ì•¡ * uniformRate); // ì†Œìˆ˜ì  ì ˆì‚¬(ë²„ë¦¼)
                            item.ì¹´ë“œìˆ˜ìˆ˜ë£Œ = ìƒˆìˆ˜ìˆ˜ë£Œ;
                            item.ì¹´ë“œìˆ˜ìˆ˜ë£Œìœ¨ = 3.5;
                            item.ì •ì‚°ì•¡ = ì •ì‚°ê¸°ì¤€ì•¡ - ìƒˆìˆ˜ìˆ˜ë£Œ;
                            ìƒˆì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ += ìƒˆìˆ˜ìˆ˜ë£Œ;
                            ìƒˆì •ì‚°ì˜ˆì •ì•¡ += item.ì •ì‚°ì•¡;
                        });
                    }

                    s.ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ = ìƒˆì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„;
                    s.ì •ì‚°ì˜ˆì •ì•¡ = ìƒˆì •ì‚°ì˜ˆì •ì•¡;
                });
            }

            const wb = XLSX.utils.book_new();
            const periodDesc = (dateStart || dateEnd) ? `${dateStart || ''} ~ ${dateEnd || ''}` : 'ì „ì²´ ê¸°ê°„';
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const generatedTime = `${today.getFullYear()}ë…„ ${today.getMonth()+1}ì›” ${today.getDate()}ì¼ ${today.getHours()}:${String(today.getMinutes()).padStart(2,'0')} ìƒì„±`;

            // ê³µí†µ í°íŠ¸: ë§‘ì€ê³ ë”•
            const fontName = 'ë§‘ì€ ê³ ë”•';

            // thin í…Œë‘ë¦¬ (ëª¨ë“  ì…€ ê¸°ë³¸)
            const thinBorder = {
                top: { style: 'thin', color: { rgb: '000000' } },
                bottom: { style: 'thin', color: { rgb: '000000' } },
                left: { style: 'thin', color: { rgb: '000000' } },
                right: { style: 'thin', color: { rgb: '000000' } }
            };

            // medium í…Œë‘ë¦¬ (ì™¸ê³½ì„ )
            const mediumBorder = {
                top: { style: 'medium', color: { rgb: '000000' } },
                bottom: { style: 'medium', color: { rgb: '000000' } },
                left: { style: 'medium', color: { rgb: '000000' } },
                right: { style: 'medium', color: { rgb: '000000' } }
            };

            // í—¬í¼: ì—´ ì¸ë±ìŠ¤ë¥¼ ë¬¸ìë¡œ ë³€í™˜ (0=A, 1=B, ...)
            function colToLetter(col) {
                return String.fromCharCode(65 + col);
            }

            // í—¬í¼: ì™¸ê³½ í…Œë‘ë¦¬ ì ìš© (startRow, endRow, startCol, endCol - ëª¨ë‘ 0-indexed)
            function applyOuterBorder(ws, startRow, endRow, startCol, endCol) {
                for (let r = startRow; r <= endRow; r++) {
                    for (let c = startCol; c <= endCol; c++) {
                        const cellRef = colToLetter(c) + (r + 1);
                        if (!ws[cellRef]) ws[cellRef] = { v: '', t: 's' };
                        if (!ws[cellRef].s) ws[cellRef].s = {};
                        if (!ws[cellRef].s.border) ws[cellRef].s.border = { ...thinBorder };

                        // ìƒë‹¨
                        if (r === startRow) {
                            ws[cellRef].s.border.top = { style: 'medium', color: { rgb: '000000' } };
                        }
                        // í•˜ë‹¨
                        if (r === endRow) {
                            ws[cellRef].s.border.bottom = { style: 'medium', color: { rgb: '000000' } };
                        }
                        // ì¢Œì¸¡
                        if (c === startCol) {
                            ws[cellRef].s.border.left = { style: 'medium', color: { rgb: '000000' } };
                        }
                        // ìš°ì¸¡
                        if (c === endCol) {
                            ws[cellRef].s.border.right = { style: 'medium', color: { rgb: '000000' } };
                        }
                    }
                }
            }

            // ========== 1. ìš”ì•½ ì‹œíŠ¸ ==========
            const summaryWs = XLSX.utils.aoa_to_sheet([]);
            const summaryHeaders = ['ìˆœìœ„', 'ê±°ë˜ì²˜', '10ì„ í˜‘ì˜íšŒ', 'í’ˆëª©ìˆ˜', 'ì¹´ë“œí’ˆëª©', 'ë¹„ì¹´ë“œí’ˆëª©', 'ì´ë§¤ì¶œ', 'ì´í• ì¸', 'ì¹´ë“œë§¤ì¶œ', 'ë¹„ì¹´ë“œë§¤ì¶œ', 'ìˆ˜ìˆ˜ë£Œ', 'ì •ì‚°ì•¡'];
            const lastCol = 11; // Lì—´ (0-indexed)

            // Row 1: íƒ€ì´í‹€ (A~L ë³‘í•©, ê°€ìš´ë°ì •ë ¬, ë³¼ë“œ, 24pt, ë°°ê²½ #FFFF00)
            const titleSuffix = uniformFee ? ' (ìˆ˜ìˆ˜ë£Œ 3.5% ì¼ê´„ì ìš©)' : '';
            XLSX.utils.sheet_add_aoa(summaryWs, [['ë¶€ì‚°ìŠˆí¼ ì •ì‚° ëŒ€ì‹œë³´ë“œ' + titleSuffix]], { origin: 'A1' });
            summaryWs['A1'].s = {
                font: { name: fontName, bold: true, sz: 24 },
                fill: { fgColor: { rgb: 'FFFF00' } },
                alignment: { horizontal: 'center', vertical: 'center' },
                border: mediumBorder
            };
            // ë³‘í•©ëœ ì…€ë“¤ë„ ë°°ê²½ìƒ‰/í…Œë‘ë¦¬ ì ìš©
            for (let c = 1; c <= lastCol; c++) {
                const cellRef = colToLetter(c) + '1';
                summaryWs[cellRef] = { v: '', t: 's', s: {
                    font: { name: fontName, bold: true, sz: 24 },
                    fill: { fgColor: { rgb: 'FFFF00' } },
                    alignment: { horizontal: 'center', vertical: 'center' },
                    border: {
                        top: { style: 'medium', color: { rgb: '000000' } },
                        bottom: { style: 'medium', color: { rgb: '000000' } },
                        left: { style: 'thin', color: { rgb: '000000' } },
                        right: c === lastCol ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } }
                    }
                }};
            }
            summaryWs['A1'].s.border.left = { style: 'medium', color: { rgb: '000000' } };

            // Row 2: ê¸°ê°„ (A~L ë³‘í•©, ì˜¤ë¥¸ìª½ì •ë ¬, 10pt)
            XLSX.utils.sheet_add_aoa(summaryWs, [[`ê¸°ê°„: ${periodDesc}`]], { origin: 'A2' });
            summaryWs['A2'].s = {
                font: { name: fontName, sz: 10 },
                alignment: { horizontal: 'right', vertical: 'center' },
                border: { top: { style: 'medium', color: { rgb: '000000' } }, bottom: { style: 'thin', color: { rgb: '000000' } }, left: { style: 'medium', color: { rgb: '000000' } }, right: { style: 'thin', color: { rgb: '000000' } } }
            };
            for (let c = 1; c <= lastCol; c++) {
                const cellRef = colToLetter(c) + '2';
                summaryWs[cellRef] = { v: '', t: 's', s: {
                    font: { name: fontName, sz: 10 },
                    alignment: { horizontal: 'right', vertical: 'center' },
                    border: {
                        top: { style: 'medium', color: { rgb: '000000' } },
                        bottom: { style: 'thin', color: { rgb: '000000' } },
                        left: { style: 'thin', color: { rgb: '000000' } },
                        right: c === lastCol ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } }
                    }
                }};
            }

            // Row 3: ìƒì„±ì‹œê° (A~L ë³‘í•©, ì˜¤ë¥¸ìª½ì •ë ¬, 10pt)
            XLSX.utils.sheet_add_aoa(summaryWs, [[generatedTime]], { origin: 'A3' });
            summaryWs['A3'].s = {
                font: { name: fontName, sz: 10 },
                alignment: { horizontal: 'right', vertical: 'center' },
                border: { top: { style: 'thin', color: { rgb: '000000' } }, bottom: { style: 'medium', color: { rgb: '000000' } }, left: { style: 'medium', color: { rgb: '000000' } }, right: { style: 'thin', color: { rgb: '000000' } } }
            };
            for (let c = 1; c <= lastCol; c++) {
                const cellRef = colToLetter(c) + '3';
                summaryWs[cellRef] = { v: '', t: 's', s: {
                    font: { name: fontName, sz: 10 },
                    alignment: { horizontal: 'right', vertical: 'center' },
                    border: {
                        top: { style: 'thin', color: { rgb: '000000' } },
                        bottom: { style: 'medium', color: { rgb: '000000' } },
                        left: { style: 'thin', color: { rgb: '000000' } },
                        right: c === lastCol ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } }
                    }
                }};
            }

            // Row 4: í—¤ë” (ê°€ìš´ë°ì •ë ¬, ë³¼ë“œ, 12pt, ë°°ê²½ #FFFF00)
            XLSX.utils.sheet_add_aoa(summaryWs, [summaryHeaders], { origin: 'A4' });
            summaryHeaders.forEach((_, idx) => {
                const cellRef = colToLetter(idx) + '4';
                if (summaryWs[cellRef]) {
                    summaryWs[cellRef].s = {
                        font: { name: fontName, bold: true, sz: 12 },
                        fill: { fgColor: { rgb: 'FFFF00' } },
                        alignment: { horizontal: 'center', vertical: 'center' },
                        border: {
                            top: { style: 'medium', color: { rgb: '000000' } },
                            bottom: { style: 'thin', color: { rgb: '000000' } },
                            left: idx === 0 ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } },
                            right: idx === lastCol ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } }
                        }
                    };
                }
            });

            // Row 5+: ë°ì´í„° (ê°€ìš´ë°ì •ë ¬, 12pt)
            const lastDataRowSummary = 4 + exportData.length;
            exportData.forEach((s, i) => {
                const row = i + 5;
                const isLastRow = (row === lastDataRowSummary);
                const rowData = [
                    i + 1, s.ê±°ë˜ì²˜, s._is10Sun ? 'O' : '',
                    s.í’ˆëª©ìˆ˜ || 0, s.ì¹´ë“œí’ˆëª©ìˆ˜ || 0, s.ë¹„ì¹´ë“œí’ˆëª©ìˆ˜ || 0,
                    s.ì´ë§¤ì¶œ || 0, s.ì´í• ì¸ || 0, s.ì¹´ë“œë§¤ì¶œ || 0, s.ë¹„ì¹´ë“œë§¤ì¶œ || 0,
                    s.ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ || 0, s.ì •ì‚°ì˜ˆì •ì•¡ || 0
                ];
                XLSX.utils.sheet_add_aoa(summaryWs, [rowData], { origin: `A${row}` });

                summaryHeaders.forEach((_, idx) => {
                    const cellRef = colToLetter(idx) + row;
                    const cell = summaryWs[cellRef];
                    if (cell) {
                        cell.s = {
                            font: { name: fontName, sz: 12 },
                            alignment: { horizontal: 'center', vertical: 'center' },
                            border: {
                                top: { style: 'thin', color: { rgb: '000000' } },
                                bottom: isLastRow ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } },
                                left: idx === 0 ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } },
                                right: idx === lastCol ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } }
                            }
                        };
                        // ìˆ«ì í¬ë§·
                        if (idx >= 3) cell.z = '#,##0';
                    }
                });
            });

            // ë³‘í•© ì„¤ì •
            summaryWs['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: lastCol } },  // Row 1
                { s: { r: 1, c: 0 }, e: { r: 1, c: lastCol } },  // Row 2
                { s: { r: 2, c: 0 }, e: { r: 2, c: lastCol } }   // Row 3
            ];

            summaryWs['!cols'] = [
                { wch: 6 }, { wch: 18 }, { wch: 10 }, { wch: 8 }, { wch: 10 }, { wch: 10 },
                { wch: 12 }, { wch: 10 }, { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 12 }
            ];
            summaryWs['!rows'] = [{ hpt: 36 }, { hpt: 20 }, { hpt: 20 }, { hpt: 24 }];

            XLSX.utils.book_append_sheet(wb, summaryWs, 'ìš”ì•½');

            // ========== 2. ìƒì„¸ ì‹œíŠ¸ ==========
            const detailWs = XLSX.utils.aoa_to_sheet([]);
            const detailHeaders = ['ì—…ì²´ëª…', 'ê²°ì œì¼ì', 'ì •ì‚°ì¼ì', 'ì¹´ë“œ/í˜„ê¸ˆ', 'ì¹´ë“œì‚¬', 'ìˆ˜ìˆ˜ë£Œìœ¨',
                'ìƒí’ˆëª…', 'ìƒí’ˆì½”ë“œ', 'ë°”ì½”ë“œ', 'ë‹¨ê°€', 'ìˆ˜ëŸ‰', 'íŒë§¤ëŒ€ê¸ˆ',
                'í• ì¸ì—¬ë¶€(ì—…ì²´)', 'í• ì¸ìœ¨(ì—…ì²´)', 'í• ì¸ì•¡(ì—…ì²´)', 'í• ì¸ì—¬ë¶€(íšŒì‚¬)', 'í• ì¸ì•¡(íšŒì‚¬)',
                'ìˆ˜ìˆ˜ë£Œ', 'ì •ì‚°ì•¡'];
            const detailLastCol = 18; // Sì—´ (0-indexed)

            // Row 1: íƒ€ì´í‹€ (A~P ë³‘í•©, ê°€ìš´ë°ì •ë ¬, ë³¼ë“œ, 24pt, ë°°ê²½ #FFFF00)
            XLSX.utils.sheet_add_aoa(detailWs, [['ë¶€ì‚°ìŠˆí¼ ì •ì‚° ëŒ€ì‹œë³´ë“œ - ìƒì„¸' + titleSuffix]], { origin: 'A1' });
            detailWs['A1'].s = {
                font: { name: fontName, bold: true, sz: 24 },
                fill: { fgColor: { rgb: 'FFFF00' } },
                alignment: { horizontal: 'center', vertical: 'center' },
                border: mediumBorder
            };
            for (let c = 1; c <= detailLastCol; c++) {
                const cellRef = colToLetter(c) + '1';
                detailWs[cellRef] = { v: '', t: 's', s: {
                    font: { name: fontName, bold: true, sz: 24 },
                    fill: { fgColor: { rgb: 'FFFF00' } },
                    alignment: { horizontal: 'center', vertical: 'center' },
                    border: {
                        top: { style: 'medium', color: { rgb: '000000' } },
                        bottom: { style: 'medium', color: { rgb: '000000' } },
                        left: { style: 'thin', color: { rgb: '000000' } },
                        right: c === detailLastCol ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } }
                    }
                }};
            }
            detailWs['A1'].s.border.left = { style: 'medium', color: { rgb: '000000' } };

            // Row 2: ê¸°ê°„ (A~P ë³‘í•©, ì˜¤ë¥¸ìª½ì •ë ¬, 10pt)
            XLSX.utils.sheet_add_aoa(detailWs, [[`ê¸°ê°„: ${periodDesc}  |  ${generatedTime}`]], { origin: 'A2' });
            detailWs['A2'].s = {
                font: { name: fontName, sz: 10 },
                alignment: { horizontal: 'right', vertical: 'center' },
                border: { top: { style: 'medium', color: { rgb: '000000' } }, bottom: { style: 'medium', color: { rgb: '000000' } }, left: { style: 'medium', color: { rgb: '000000' } }, right: { style: 'thin', color: { rgb: '000000' } } }
            };
            for (let c = 1; c <= detailLastCol; c++) {
                const cellRef = colToLetter(c) + '2';
                detailWs[cellRef] = { v: '', t: 's', s: {
                    font: { name: fontName, sz: 10 },
                    alignment: { horizontal: 'right', vertical: 'center' },
                    border: {
                        top: { style: 'medium', color: { rgb: '000000' } },
                        bottom: { style: 'medium', color: { rgb: '000000' } },
                        left: { style: 'thin', color: { rgb: '000000' } },
                        right: c === detailLastCol ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } }
                    }
                }};
            }

            // Row 3: í—¤ë” (ê°€ìš´ë°ì •ë ¬, ë³¼ë“œ, 12pt, ë°°ê²½ #FFFF00)
            XLSX.utils.sheet_add_aoa(detailWs, [detailHeaders], { origin: 'A3' });
            detailHeaders.forEach((_, idx) => {
                const cellRef = colToLetter(idx) + '3';
                if (detailWs[cellRef]) {
                    detailWs[cellRef].s = {
                        font: { name: fontName, bold: true, sz: 12 },
                        fill: { fgColor: { rgb: 'FFFF00' } },
                        alignment: { horizontal: 'center', vertical: 'center' },
                        border: {
                            top: { style: 'medium', color: { rgb: '000000' } },
                            bottom: { style: 'thin', color: { rgb: '000000' } },
                            left: idx === 0 ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } },
                            right: idx === detailLastCol ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } }
                        }
                    };
                }
            });

            // Row 4+: ë°ì´í„°
            const detailMerges = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: detailLastCol } },  // Row 1 íƒ€ì´í‹€
                { s: { r: 1, c: 0 }, e: { r: 1, c: detailLastCol } }   // Row 2 ê¸°ê°„
            ];
            let currentRow = 4; // 0-indexed = row 4 in Excel

            // ì „ì²´ ë°ì´í„° í–‰ ìˆ˜ ê³„ì‚°
            let totalDetailRows = 0;
            exportData.forEach(s => {
                totalDetailRows += (s.í’ˆëª©ë³„ìƒì„¸ || []).length;
            });
            const lastDataRowDetail = 3 + totalDetailRows; // 0-indexed

            exportData.forEach((s) => {
                const items = s.í’ˆëª©ë³„ìƒì„¸ || [];
                if (items.length === 0) return;

                const startRow = currentRow;

                items.forEach((item, itemIdx) => {
                    const excelRow = currentRow + 1; // 1-indexed for Excel
                    const isLastRow = (currentRow === lastDataRowDetail);

                    // ì—…ì²´ë¶€ë‹´ vs íšŒì‚¬ë¶€ë‹´ ë¶„ë¦¬
                    const isì—…ì²´ë¶€ë‹´ = item.ë¶€ë‹´ì£¼ì²´ === 'ê±°ë˜ì²˜';
                    const isíšŒì‚¬ë¶€ë‹´ = item.ë¶€ë‹´ì£¼ì²´ === 'íŒë§¤ì';

                    const rowData = [
                        s.ê±°ë˜ì²˜,
                        item.ê²°ì œì¼ì || '',
                        item.ì •ì‚°ì¼ì || '',
                        item.ì¹´ë“œì—¬ë¶€ ? 'ì¹´ë“œ' : 'í˜„ê¸ˆ',
                        item.ì¹´ë“œì‚¬ || '',
                        item.ì¹´ë“œìˆ˜ìˆ˜ë£Œìœ¨ > 0 ? item.ì¹´ë“œìˆ˜ìˆ˜ë£Œìœ¨ + '%' : '',
                        item.ìƒí’ˆëª… || '',
                        item.ìƒí’ˆì½”ë“œ || '',
                        item.ìƒí’ˆë°”ì½”ë“œ || '',
                        item.íŒë§¤ë‹¨ê°€ || 0,
                        item.ìˆ˜ëŸ‰ || 1,
                        item.ì´ë§¤ì¶œì•¡ || 0,
                        // ì—…ì²´ë¶€ë‹´ í• ì¸
                        (isì—…ì²´ë¶€ë‹´ && item.í• ì¸ì—¬ë¶€) ? 'Y' : '',
                        (isì—…ì²´ë¶€ë‹´ && item.í• ì¸ìœ¨ > 0) ? item.í• ì¸ìœ¨ + '%' : '',
                        (isì—…ì²´ë¶€ë‹´ && item.í• ì¸ì•¡ > 0) ? item.í• ì¸ì•¡ : '',
                        // íšŒì‚¬ë¶€ë‹´ í• ì¸
                        (isíšŒì‚¬ë¶€ë‹´ && item.í• ì¸ì—¬ë¶€) ? 'Y' : '',
                        (isíšŒì‚¬ë¶€ë‹´ && item.í• ì¸ì•¡ > 0) ? item.í• ì¸ì•¡ : '',
                        item.ì¹´ë“œìˆ˜ìˆ˜ë£Œ || 0,
                        item.ì •ì‚°ì•¡ || 0
                    ];
                    XLSX.utils.sheet_add_aoa(detailWs, [rowData], { origin: `A${excelRow}` });

                    // ìŠ¤íƒ€ì¼ ì ìš© (ê°€ìš´ë°ì •ë ¬, 12pt)
                    detailHeaders.forEach((_, idx) => {
                        const cellRef = colToLetter(idx) + excelRow;
                        const cell = detailWs[cellRef];
                        if (cell) {
                            cell.s = {
                                font: { name: fontName, sz: 12 },
                                alignment: { horizontal: 'center', vertical: 'center' },
                                border: {
                                    top: { style: 'thin', color: { rgb: '000000' } },
                                    bottom: isLastRow ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } },
                                    left: idx === 0 ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } },
                                    right: idx === detailLastCol ? { style: 'medium', color: { rgb: '000000' } } : { style: 'thin', color: { rgb: '000000' } }
                                }
                            };
                            // ìˆ«ì í¬ë§· (ë‹¨ê°€, ìˆ˜ëŸ‰, íŒë§¤ëŒ€ê¸ˆ, í• ì¸ì•¡(ì—…ì²´), í• ì¸ì•¡(íšŒì‚¬), ìˆ˜ìˆ˜ë£Œ, ì •ì‚°ì•¡)
                            if ([9, 10, 11, 14, 16, 17, 18].includes(idx)) cell.z = '#,##0';
                        }
                    });

                    currentRow++;
                });

                // ì—…ì²´ëª… ë³‘í•© (Aì—´)
                if (items.length > 1) {
                    detailMerges.push({
                        s: { r: startRow, c: 0 },
                        e: { r: currentRow - 1, c: 0 }
                    });
                }
            });

            detailWs['!merges'] = detailMerges;
            detailWs['!cols'] = [
                { wch: 14 }, { wch: 11 }, { wch: 11 }, { wch: 8 }, { wch: 8 }, { wch: 8 },
                { wch: 22 }, { wch: 10 }, { wch: 14 }, { wch: 8 }, { wch: 5 }, { wch: 10 },
                { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 },
                { wch: 10 }, { wch: 12 }
            ];
            detailWs['!rows'] = [{ hpt: 36 }, { hpt: 20 }, { hpt: 24 }];

            XLSX.utils.book_append_sheet(wb, detailWs, 'ìƒì„¸');

            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const feeSuffix = uniformFee ? '_ìˆ˜ìˆ˜ë£Œ3.5%ì¼ê´„' : '';
            XLSX.writeFile(wb, `ì •ì‚°ë¦¬í¬íŠ¸_${dateStr}${feeSuffix}.xlsx`);
        }

        // ì •ì‚°ìš© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ìƒ˜í”Œ íŒŒì¼ í˜•ì‹)
        function exportExcelSettlement() {
            closeExportModal();

            if (typeof XLSX === 'undefined') {
                alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            // 3.5% ìˆ˜ìˆ˜ë£Œ ì¼ê´„ ì ìš©
            let exportData = JSON.parse(JSON.stringify(settlementData));
            const uniformRate = 0.035;

            exportData.forEach(s => {
                let ìƒˆì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ = 0;
                let ìƒˆì •ì‚°ì˜ˆì •ì•¡ = 0;

                if (s.í’ˆëª©ë³„ìƒì„¸) {
                    s.í’ˆëª©ë³„ìƒì„¸.forEach(item => {
                        const ì •ì‚°ê¸°ì¤€ì•¡ = item.ì •ì‚°ì•¡ + (item.ì¹´ë“œìˆ˜ìˆ˜ë£Œ || 0);
                        const ìƒˆìˆ˜ìˆ˜ë£Œ = Math.trunc(ì •ì‚°ê¸°ì¤€ì•¡ * uniformRate);
                        item.ì¹´ë“œìˆ˜ìˆ˜ë£Œ = ìƒˆìˆ˜ìˆ˜ë£Œ;
                        item.ì •ì‚°ì•¡ = ì •ì‚°ê¸°ì¤€ì•¡ - ìƒˆìˆ˜ìˆ˜ë£Œ;
                        ìƒˆì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ += ìƒˆìˆ˜ìˆ˜ë£Œ;
                        ìƒˆì •ì‚°ì˜ˆì •ì•¡ += item.ì •ì‚°ì•¡;
                    });
                }
                s.ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ = ìƒˆì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„;
                s.ì •ì‚°ì˜ˆì •ì•¡ = ìƒˆì •ì‚°ì˜ˆì •ì•¡;
            });

            const wb = XLSX.utils.book_new();
            const periodDesc = (dateStart || dateEnd) ? `${dateStart || ''} ~ ${dateEnd || ''}` : 'ì „ì²´ ê¸°ê°„';
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];

            const fontName = 'ë§‘ì€ ê³ ë”•';
            const thinBorder = {
                top: { style: 'thin', color: { rgb: '000000' } },
                bottom: { style: 'thin', color: { rgb: '000000' } },
                left: { style: 'thin', color: { rgb: '000000' } },
                right: { style: 'thin', color: { rgb: '000000' } }
            };

            function colToLetter(col) {
                if (col < 26) return String.fromCharCode(65 + col);
                return String.fromCharCode(65 + Math.floor(col / 26) - 1) + String.fromCharCode(65 + (col % 26));
            }

            // ========== 1. ìš”ì•½ ì‹œíŠ¸ ==========
            const summaryWs = XLSX.utils.aoa_to_sheet([]);
            const summaryHeaders = ['#', 'ê±°ë˜ì²˜', '10ì„ ', 'í’ˆëª©ìˆ˜', 'ì´ë§¤ì¶œ', 'ì´í• ì¸', 'ìˆ˜ìˆ˜ë£Œ', 'ì •ì‚°ì•¡'];
            const summaryLastCol = 7;

            // í—¤ë” ì¶”ê°€
            XLSX.utils.sheet_add_aoa(summaryWs, [summaryHeaders], { origin: 'A1' });
            summaryHeaders.forEach((_, idx) => {
                const cellRef = colToLetter(idx) + '1';
                if (summaryWs[cellRef]) {
                    summaryWs[cellRef].s = {
                        font: { name: fontName, bold: true, sz: 11 },
                        fill: { fgColor: { rgb: 'FFFF00' } },
                        alignment: { horizontal: 'center', vertical: 'center' },
                        border: thinBorder
                    };
                }
            });

            // ë°ì´í„° ì¶”ê°€
            exportData.forEach((s, i) => {
                const row = i + 2;
                const rowData = [
                    i + 1, s.ê±°ë˜ì²˜, s._is10Sun ? 'O' : '',
                    s.í’ˆëª©ìˆ˜ || 0, s.ì´ë§¤ì¶œ || 0, s.ì´í• ì¸ || 0,
                    s.ì¹´ë“œìˆ˜ìˆ˜ë£Œí•©ê³„ || 0, s.ì •ì‚°ì˜ˆì •ì•¡ || 0
                ];
                XLSX.utils.sheet_add_aoa(summaryWs, [rowData], { origin: `A${row}` });

                summaryHeaders.forEach((_, idx) => {
                    const cellRef = colToLetter(idx) + row;
                    const cell = summaryWs[cellRef];
                    if (cell) {
                        cell.s = {
                            font: { name: fontName, sz: 11 },
                            alignment: { horizontal: 'center', vertical: 'center' },
                            border: thinBorder
                        };
                        if (idx >= 3) cell.z = '#,##0';
                    }
                });
            });

            summaryWs['!cols'] = [
                { wch: 5 }, { wch: 16 }, { wch: 5 }, { wch: 8 },
                { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 12 }
            ];
            XLSX.utils.book_append_sheet(wb, summaryWs, 'ìš”ì•½');

            // ========== 2. ìƒì„¸ ì‹œíŠ¸ ==========
            const detailWs = XLSX.utils.aoa_to_sheet([]);
            const detailHeaders = ['ì—…ì²´ëª…', 'ê²°ì œì¼ì', 'ìƒí’ˆëª…', 'ìƒí’ˆì½”ë“œ', 'ë°”ì½”ë“œ', 'ë‹¨ê°€', 'ìˆ˜ëŸ‰', 'íŒë§¤ëŒ€ê¸ˆ',
                'í• ì¸ì—¬ë¶€(ì—…ì²´ë¶€ë‹´)', 'í• ì¸ìœ¨(ì—…ì²´ë¶€ë‹´)', 'í• ì¸ì•¡(ì—…ì²´ë¶€ë‹´)',
                'í• ì¸ì—¬ë¶€(íšŒì‚¬ë¶€ë‹´)', 'í• ì¸ì•¡(íšŒì‚¬ë¶€ë‹´)', 'ì¹´ë“œìˆ˜ìˆ˜ë£Œ(3.5%)', 'ì •ì‚°ì•¡'];
            const detailLastCol = 14;

            // í—¤ë” ì¶”ê°€
            XLSX.utils.sheet_add_aoa(detailWs, [detailHeaders], { origin: 'A1' });
            detailHeaders.forEach((_, idx) => {
                const cellRef = colToLetter(idx) + '1';
                if (detailWs[cellRef]) {
                    detailWs[cellRef].s = {
                        font: { name: fontName, bold: true, sz: 11 },
                        fill: { fgColor: { rgb: 'FFFF00' } },
                        alignment: { horizontal: 'center', vertical: 'center' },
                        border: thinBorder
                    };
                }
            });

            // ë°ì´í„° ì¶”ê°€
            let currentRow = 2;
            const detailMerges = [];

            exportData.forEach((s) => {
                const items = s.í’ˆëª©ë³„ìƒì„¸ || [];
                if (items.length === 0) return;

                const startRow = currentRow;

                items.forEach((item) => {
                    const isì—…ì²´ë¶€ë‹´ = item.ë¶€ë‹´ì£¼ì²´ === 'ê±°ë˜ì²˜';
                    const isíšŒì‚¬ë¶€ë‹´ = item.ë¶€ë‹´ì£¼ì²´ === 'íŒë§¤ì';

                    const rowData = [
                        s.ê±°ë˜ì²˜,
                        item.ê²°ì œì¼ì || '',
                        item.ìƒí’ˆëª… || '',
                        item.ìƒí’ˆì½”ë“œ || '',
                        item.ìƒí’ˆë°”ì½”ë“œ || '',
                        item.íŒë§¤ë‹¨ê°€ || 0,
                        item.ìˆ˜ëŸ‰ || 1,
                        item.ì´ë§¤ì¶œì•¡ || 0,
                        (isì—…ì²´ë¶€ë‹´ && item.í• ì¸ì—¬ë¶€) ? 'Y' : '',
                        (isì—…ì²´ë¶€ë‹´ && item.í• ì¸ìœ¨ > 0) ? item.í• ì¸ìœ¨ + '%' : '',
                        (isì—…ì²´ë¶€ë‹´ && item.í• ì¸ì•¡ > 0) ? item.í• ì¸ì•¡ : '',
                        (isíšŒì‚¬ë¶€ë‹´ && item.í• ì¸ì—¬ë¶€) ? 'Y' : '',
                        (isíšŒì‚¬ë¶€ë‹´ && item.í• ì¸ì•¡ > 0) ? item.í• ì¸ì•¡ : '',
                        item.ì¹´ë“œìˆ˜ìˆ˜ë£Œ || 0,
                        item.ì •ì‚°ì•¡ || 0
                    ];
                    XLSX.utils.sheet_add_aoa(detailWs, [rowData], { origin: `A${currentRow}` });

                    detailHeaders.forEach((_, idx) => {
                        const cellRef = colToLetter(idx) + currentRow;
                        const cell = detailWs[cellRef];
                        if (cell) {
                            cell.s = {
                                font: { name: fontName, sz: 11 },
                                alignment: { horizontal: 'center', vertical: 'center' },
                                border: thinBorder
                            };
                            if ([5, 6, 7, 10, 12, 13, 14].includes(idx)) cell.z = '#,##0';
                        }
                    });

                    currentRow++;
                });

                if (items.length > 1) {
                    detailMerges.push({
                        s: { r: startRow - 1, c: 0 },
                        e: { r: currentRow - 2, c: 0 }
                    });
                }
            });

            detailWs['!merges'] = detailMerges;
            detailWs['!cols'] = [
                { wch: 14 }, { wch: 11 }, { wch: 22 }, { wch: 10 }, { wch: 14 },
                { wch: 8 }, { wch: 5 }, { wch: 10 },
                { wch: 14 }, { wch: 14 }, { wch: 12 },
                { wch: 14 }, { wch: 12 }, { wch: 14 }, { wch: 12 }
            ];
            XLSX.utils.book_append_sheet(wb, detailWs, 'ìƒì„¸');

            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(wb, `ë¶€ì‚°ìŠˆí¼_ì •ì‚°_${dateStr}_POSê¸°ì¤€.xlsx`);
        }
    </script>
</body>
</html>
