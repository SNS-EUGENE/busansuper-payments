# 카드 결제 데이터 검증 프로그램

카드 결제 데이터의 정합성을 검증하고 수수료를 분석하는 프로그램입니다.

## 주요 기능

### 1. 데이터 파싱 및 로드
- **기간별 매입내역.xlsx**: 여신금융협회에서 조회한 카드사별 매입 내역
- **포스 카드결제내역.xlsx**: POS 시스템의 실제 결제 내역
- **영수증별매출상세현황.xlsx**: 영수증별 상세 품목 내역

### 2. 수수료율 역산 분석
- 카드사별 실제 적용된 수수료율 계산
- 부가세 포함/제외 수수료율 분석
- 수수료율 분포 확인
- 예상 수수료율과 비교 검증

### 3. 데이터 매칭 검증
- 포스 결제내역 ↔ 매입내역 승인번호 기반 매칭
- 승인/취소 구분 필터링
- 누락 내역 자동 검출
  - 포스에만 있는 내역 (매입 누락)
  - 매입에만 있는 내역 (포스 누락)

### 4. 웹 대시보드
- 시각적인 데이터 확인
- 통계 요약
- 상세 내역 테이블
- 리포트 다운로드

## 설치 방법

```bash
# Node.js 패키지 설치
npm install xlsx
```

## 사용 방법

### 1. 기본 분석 실행

```bash
node card_analyzer.js
```

**출력 내용:**
- 각 파일별 로드된 데이터 건수
- 카드사별 수수료율 역산 결과
- 매입내역 ↔ 포스결제 매칭 결과
- 영수증별 매출 요약
- 검증리포트 JSON 파일 생성

### 2. 상세 분석 리포트 생성

```bash
node detailed_report.js
```

**출력 내용:**
- 포스에만 있는 내역 상세 분석 (카드사별)
- 매입에만 있는 내역 상세 분석
- 수수료율 2.3%, 3.5% 근처 샘플 분석
- CSV 파일 생성:
  - `포스누락내역.csv`
  - `매입누락내역.csv`

### 3. 웹 대시보드 실행

```bash
node server.js
```

브라우저에서 `http://localhost:3000` 접속 후 **"분석 실행"** 버튼 클릭

**대시보드 기능:**
- 실시간 통계 카드 (매입/포스/매칭 건수, 총 수수료)
- 카드사별 수수료 분석 테이블 (건수, 금액, 수수료율, 분포)
- 매칭 오류 내역 확인 (포스 전용, 매입 전용)
- 리포트 다운로드
- 실시간 API 기반 분석 (엑셀 파일을 실시간으로 분석)

## 파일 구조

```
카드결제내역/
├── 기간별 매입내역.xlsx          # 입력: 여신금융협회 매입내역
├── 포스 카드결제내역.xlsx        # 입력: POS 결제내역
├── 250910-251116 영수증별매출상세현황.xlsx  # 입력: 영수증 상세
├── 카드별 수수료율 및 대금지급주기.png      # 참고: 카드사별 수수료 정보
│
├── card_analyzer.js              # 핵심 분석 모듈
├── detailed_report.js            # 상세 리포트 생성
├── dashboard.html                # 웹 대시보드 UI
├── server.js                     # 웹 서버
├── analyze_structure.js          # 파일 구조 분석 (디버깅용)
├── debug_pos.js                  # 포스 파일 디버깅 (디버깅용)
│
├── 검증리포트_2025-11-17.json    # 출력: JSON 리포트
├── 포스누락내역.csv              # 출력: 포스 전용 내역
└── 매입누락내역.csv              # 출력: 매입 전용 내역
```

## 분석 결과 예시

### 수수료율 분석 결과

```
KB카드:
  건수: 89건
  총 매입금액: 2,538,340원
  총 수수료: 53,119원
  평균 수수료율: 2.093%
  수수료율 분포 (상위 3개):
    2.300%: 24건
    1.500%: 12건
    2.299%: 8건
```

**해석:**
- 2.3%: 수수료 + 부가세 (실제 수수료 약 2.09%)
- 1.5%: 전문계 수수료율
- 카드사별로 온라인/전문계 수수료율이 혼재

### 매칭 검증 결과

```
포스 승인건: 484건
✓ 매칭 성공: 454건
⚠ 포스에만 있음: 30건
⚠ 매입에만 있음: 6건
```

**포스에만 있는 내역 (30건) 원인:**
- 승인번호 누락 (빈 값)
- 최근 거래로 아직 매입 처리 안됨
- 해외 결제 (매입내역에서 제외)

**매입에만 있는 내역 (6건) 원인:**
- 포스 시스템 오류
- 수동 입력 건
- 날짜 범위 차이

## 주요 발견 사항

### 1. 수수료율 종류

| 수수료율 | 건수 | 설명 |
|---------|------|------|
| 1.35% | - | KB/BC 온라인 수수료 |
| 1.5% | 다수 | 대부분 카드사 전문계 수수료 |
| 2.3% | 240건 | 수수료 + 부가세 (2.09% × 1.1) |
| 3.5% | 95건 | 신한카드 일부 (원인 분석 필요) |

### 2. 데이터 검증 포인트

✅ **확인된 사항:**
- 승인번호 기반 매칭은 93.8% 성공률 (454/484)
- 부가세 포함 수수료율이 주로 사용됨
- 카드사별 수수료율이 계약서 내용과 대체로 일치

⚠ **주의 사항:**
- 승인번호가 없는 포스 내역 존재
- 취소 건은 자동 필터링됨 (정상)
- 일부 3.5% 수수료율 건은 추가 조사 필요

## 커스터마이징

### 수수료율 정보 수정

[card_analyzer.js](card_analyzer.js:6) 파일의 `CARD_FEE_INFO` 객체를 수정하세요:

```javascript
const CARD_FEE_INFO = {
    'KB카드': { online: 1.35, expert: 1.5, days: 2 },
    '신한카드': { online: 0, expert: 1.5, days: 2 },
    // 추가 카드사...
};
```

### 매칭 로직 수정

[card_analyzer.js:235](card_analyzer.js:235)의 `match매입포스()` 함수에서 승인번호 외 추가 조건을 설정할 수 있습니다.

## 문제 해결

### Q. "매입내역 헤더를 찾을 수 없습니다" 오류
**A.** 엑셀 파일 형식이 예상과 다릅니다. [analyze_structure.js](analyze_structure.js)를 실행하여 파일 구조를 확인하세요.

### Q. 포스 승인건이 0건으로 나옴
**A.** 포스 파일의 헤더 구조를 확인하세요. `debug_pos.js`를 실행하여 컬럼명을 확인할 수 있습니다.

### Q. 웹 대시보드가 안 열림
**A.** `node server.js` 실행 후 `http://localhost:3000`으로 접속하세요. 포트 3000이 사용중이면 [server.js:6](server.js:6)에서 포트 번호를 변경하세요.

## 라이선스

MIT License

## 개발 정보

- 개발일: 2025-11-17
- Node.js 버전: v20.19.4
- 주요 라이브러리: xlsx
